<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skeletal Path Model</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    svg {
      border: 1px solid #ccc;
    }
    .node circle {
      fill: lightblue;
      stroke: steelblue;
      stroke-width: 2px;
    }
    .node text {
      font-size: 14px;
    }
    .leak-indicator {
      fill: red;
      font-size: 18px;
    }
    .eq-box {
      margin-top: 20px;
      padding: 10px;
      background-color: #f4f4f4;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>Skeletal Path Model</h2>
  <p>Click a node to move the leak (output node cannot leak).</p>
  <svg width="600" height="150"></svg>

  <div class="eq-box">
    <strong>Input-Output Equation:</strong>
    <div id="equation"></div>
  </div>

  <script>
    const nodes = [
      { id: 0, label: "1" },
      { id: 1, label: "2" },
      { id: 2, label: "3" },
      { id: 3, label: "4" },
    ];

    const links = [
      { source: 0, target: 1 },
      { source: 1, target: 2 },
      { source: 2, target: 3 },
    ];

    let leakNode = 0; // Initial leak location

    const eqLookup = {
      0: "y^{(3)} + (a_{01}+a_{12}+a_{23}) y'' + (a_{01}a_{12}+a_{12}a_{23}) y' + a_{01}a_{12}a_{23} y = u",
      1: "y^{(3)} + (a_{02}+a_{12}+a_{23}) y'' + (a_{02}a_{12}+a_{12}a_{23}) y' + a_{02}a_{12}a_{23} y = u",
      2: "y^{(3)} + (a_{03}+a_{12}+a_{23}) y'' + (a_{03}a_{12}+a_{12}a_{23}) y' + a_{03}a_{12}a_{23} y = u",
      3: "\\text{No leak allowed in the output node.}"
    };

    const svg = d3.select("svg");

    const nodeGroup = svg.selectAll("g.node")
      .data(nodes)
      .enter()
      .append("g")
      .attr("class", "node")
      .attr("transform", (d, i) => `translate(${100 + i * 120}, 75)`)
      .on("click", (event, d) => {
        if (d.id === 3) return; // prevent leak on output
        leakNode = d.id;
        drawLeak();
        updateEquation();
      });

    nodeGroup.append("circle").attr("r", 25);
    nodeGroup.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", 5)
      .text(d => d.label);

    svg.selectAll("line.link")
      .data(links)
      .enter()
      .append("line")
      .attr("class", "link")
      .attr("stroke", "gray")
      .attr("stroke-width", 2)
      .attr("x1", d => 100 + d.source * 120)
      .attr("y1", 75)
      .attr("x2", d => 100 + d.target * 120)
      .attr("y2", 75);

// Draw input arrow to node 1
svg.append("line")
  .attr("x1", 40)
  .attr("y1", 75)
  .attr("x2", 75)
  .attr("y2", 75)
  .attr("stroke", "green")
  .attr("stroke-width", 3)
  .attr("marker-end", "url(#arrow)");

svg.append("text")
  .attr("x", 30)
  .attr("y", 70)
  .attr("text-anchor", "start")
  .attr("fill", "green")
  .text("in");

// Define marker (arrowhead)
svg.append("defs").append("marker")
  .attr("id", "arrow")
  .attr("viewBox", "0 0 10 10")
  .attr("refX", 10)
  .attr("refY", 5)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto-start-reverse")
  .append("path")
  .attr("d", "M 0 0 L 10 5 L 0 10 z")
  .attr("fill", "green");


// Draw output line from node 4 with a circle
svg.append("line")
  .attr("x1", 100 + 3 * 120 + 25)  // right edge of node 4
  .attr("y1", 75)
  .attr("x2", 100 + 3 * 120 + 60)  // some distance to the right
  .attr("y2", 75)
  .attr("stroke", "purple")
  .attr("stroke-width", 3);

svg.append("circle")
  .attr("cx", 100 + 3 * 120 + 60)  // at end of line
  .attr("cy", 75)
  .attr("r", 5)
  .attr("fill", "purple");

svg.append("text")
  .attr("x", 100 + 3 * 120 + 70)
  .attr("y", 70)
  .attr("text-anchor", "start")
  .attr("fill", "purple")
  .text("out");



    
    function drawLeak() {
      svg.selectAll("text.leak-indicator").remove();
      svg.append("text")
        .attr("class", "leak-indicator")
        .attr("x", 100 + leakNode * 120)
        .attr("y", 40)
        .text("\u2744"); // Snowflake icon as leak
    }

    function updateEquation() {
      const eqDiv = document.getElementById("equation");
      katex.render(eqLookup[leakNode], eqDiv, { throwOnError: false });
    }

    drawLeak();
    updateEquation();
  </script>
</body>
</html>
